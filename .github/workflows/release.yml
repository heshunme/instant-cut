name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šv æ ¼å¼çš„ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0

permissions:
  contents: write  # ä»…å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  # ç”Ÿæˆ Release Notes
  generate-release-notes:
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
      is-first-release: ${{ steps.changelog.outputs.is-first-release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºæ¯”è¾ƒç‰ˆæœ¬

      - name: Generate changelog
        id: changelog
        run: |
          # è·å–å½“å‰ç‰ˆæœ¬æ ‡ç­¾
          CURRENT_TAG=${{ github.ref_name }}

          # è·å–ä¸Šä¸ªç‰ˆæœ¬æ ‡ç­¾
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # åˆ¤æ–­æ˜¯å¦ä¸ºé¦–æ¬¡å‘å¸ƒ
          if [ -z "$PREV_TAG" ]; then
            printf "is-first-release=true\n" >> $GITHUB_OUTPUT
            printf "changelog=## ğŸ‰ é¦–æ¬¡å‘å¸ƒ\n\nè¿™æ˜¯ Fast Video Cutter çš„é¦–ä¸ªæ­£å¼ç‰ˆæœ¬ã€‚\n\n### âœ¨ ä¸»è¦ç‰¹æ€§\n- ğŸš€ æé€Ÿæ— é‡ç¼–ç è§†é¢‘å‰ªè¾‘\n- ğŸ“ æ™ºèƒ½ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿ\n- ğŸ¨ æç®€é»‘ç™½ UI è®¾è®¡\n- ğŸ’¬ æ”¯æŒå¤‡æ³¨åŠŸèƒ½\n- ğŸ”„ å®æ—¶è§†é¢‘é¢„è§ˆ\n- âœ… ç£ç›˜ç©ºé—´å®‰å…¨æ£€æŸ¥\n\n### ğŸ“‹ ç³»ç»Ÿè¦æ±‚\n- Windows/macOS/Linux æ“ä½œç³»ç»Ÿ\n- å·²å®‰è£… [FFmpeg](https://ffmpeg.org/) å’Œ FFprobe\n\n### ğŸš€ ä½¿ç”¨æ–¹æ³•\nä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç›´æ¥è¿è¡Œå³å¯ã€‚\n" >> $GITHUB_OUTPUT
          else
            printf "is-first-release=false\n" >> $GITHUB_OUTPUT
            # ç”ŸæˆåŒ…å«ç‰ˆæœ¬é—´ commit é“¾æ¥çš„æ›´æ–°å†…å®¹
            printf "changelog=## ğŸ“ æ›´æ–°å†…å®¹\n\n### ğŸ”— å˜æ›´è®°å½•\n\næŸ¥çœ‹ [${PREV_TAG}...${CURRENT_TAG}](https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${CURRENT_TAG}) çš„è¯¦ç»†æäº¤è®°å½•ã€‚\n\n### ğŸ“‹ ç³»ç»Ÿè¦æ±‚\n- Windows/macOS/Linux æ“ä½œç³»ç»Ÿ\n- å·²å®‰è£… [FFmpeg](https://ffmpeg.org/) å’Œ FFprobe\n\n### ğŸš€ ä½¿ç”¨æ–¹æ³•\nä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç›´æ¥è¿è¡Œå³å¯ã€‚\n" >> $GITHUB_OUTPUT
          fi

  # æ„å»ºå„ä¸ªå¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
  build:
    needs: generate-release-notes
    strategy:
      fail-fast: false  # å•ä¸ªå¹³å°å¤±è´¥ä¸å½±å“å…¶ä»–å¹³å°
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: instant-cut.exe
            asset_name: instant-cut-windows-x64.exe
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: instant-cut
            asset_name: instant-cut-macos-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: instant-cut
            asset_name: instant-cut-macos-aarch64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: instant-cut
            asset_name: instant-cut-linux-x64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # å®‰è£… Rust
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # å®‰è£… Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # ç¼“å­˜ Rust ä¾èµ–
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/
            ~/.cargo/git/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-
            ${{ runner.os }}-cargo-

      # ç¼“å­˜ç³»ç»Ÿä¾èµ–ï¼ˆUbuntuï¼‰
      - name: Cache system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/release.yml') }}

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci

      # å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆä»… Ubuntuï¼‰
      - name: Install system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config build-essential libclang-dev libwebkit2gtk-4.1-dev libssl-dev libayatana-appindicator3-dev libglib2.0-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev libsoup-3.0-dev libjavascriptcoregtk-4.1-dev

      # æ„å»º Tauri åº”ç”¨
      - name: Build Tauri app
        run: npm run tauri build -- --target ${{ matrix.target }}

      # å‡†å¤‡æ„å»ºäº§ç‰©
      - name: Prepare artifacts
        shell: bash
        run: |
          # æ ¹æ®å¹³å°ç¡®å®šæ„å»ºäº§ç‰©è·¯å¾„
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            ARTIFACT_PATH="src-tauri/target/${{ matrix.target }}/release/${{ matrix.artifact_name }}"
          else
            ARTIFACT_PATH="src-tauri/target/${{ matrix.target }}/release/${{ matrix.artifact_name }}"
          fi

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$ARTIFACT_PATH" ]; then
            echo "âŒ æ„å»ºäº§ç‰©ä¸å­˜åœ¨: $ARTIFACT_PATH"
            exit 1
          fi

          # ä¸º Linux å’Œ macOS æ–‡ä»¶æ·»åŠ æ‰§è¡Œæƒé™
          if [[ "${{ matrix.os }}" != "windows-latest" ]]; then
            chmod +x "$ARTIFACT_PATH"
          fi

          # å¤åˆ¶åˆ°ä¸´æ—¶ç›®å½•å¹¶é‡å‘½å
          mkdir -p artifacts
          cp "$ARTIFACT_PATH" "artifacts/${{ matrix.asset_name }}"

          echo "âœ… æ„å»ºäº§ç‰©å‡†å¤‡å®Œæˆ: artifacts/${{ matrix.asset_name }}"

      # ä¸Šä¼ æ„å»ºäº§ç‰©ä½œä¸ºä¸´æ—¶ artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: artifacts/${{ matrix.asset_name }}
          retention-days: 30

  # åˆ›å»º GitHub Release
  create-release:
    needs: [generate-release-notes, build]
    runs-on: ubuntu-latest
    if: success()  # åªæœ‰æ‰€æœ‰æ„å»ºæˆåŠŸæ‰åˆ›å»º Release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # åˆ›å»º GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          body: ${{ needs.generate-release-notes.outputs.changelog }}
          files: artifacts/**/*
          draft: false
          prerelease: false
          generate_release_notes: false  # ä½¿ç”¨è‡ªå®šä¹‰çš„ release notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ¸…ç†ä¸´æ—¶ artifacts
  cleanup:
    needs: create-release
    runs-on: ubuntu-latest
    if: always()  # æ— è®ºæˆåŠŸä¸å¦éƒ½æ‰§è¡Œæ¸…ç†

    steps:
      - name: Cleanup artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            instant-cut-windows-x64.exe
            instant-cut-macos-x64
            instant-cut-macos-aarch64
            instant-cut-linux-x64
          failOnError: false